@model OpenDataVR.Models.JugadoresIndexVM

@{
    string Toggle(string col)
    {
        var o = Model.Orden ?? "Id";
        return o == col ? col + "_desc" : col;
    }

    string Arrow(string col)
    {
        var o = Model.Orden ?? "Id";
        if (o == col) return " ▲";
        if (o == col + "_desc") return " ▼";
        return "";
    }

    string BuildUrlOrden(string orden) => Url.Action("Index", "Jugadores", new
    {
        buscar = Model.Buscar,
        arquetipo = Model.Arquetipo,
        posicion = Model.Posicion,
        elemento = Model.Elemento,
        rol = Model.Rol,
        orden = orden,
        pagina = 1
    })!;

    string BuildResetKeep(string? buscar = null, string? arquetipo = null, string? posicion = null, string? elemento = null, string? rol = null)
        => Url.Action("Index", "Jugadores", new
        {
            buscar = buscar,
            arquetipo = arquetipo,
            posicion = posicion,
            elemento = elemento,
            rol = rol,
            orden = Model.Orden,
            pagina = 1
        })!;

    string BadgeElemento(string? el)
    {
        el ??= "";
        return el switch
        {
            "Fire" => "bg-danger",
            "Wind" => "bg-info",
            "Forest" => "bg-success",
            "Mountain" => "bg-secondary",
            "?" => "bg-secondary",
            _ => "bg-dark"
        };
    }

    string BadgePosicion(string? p)
    {
        p ??= "";
        return p switch
        {
            "FW" => "bg-danger",
            "MF" => "bg-primary",
            "DF" => "bg-success",
            "GK" => "bg-dark",
            "?" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    string BadgeArquetipo(string? a)
    {
        a ??= "";
        if (a == "Unknown" || a == "" || a == "?") return "bg-secondary";
        return "bg-primary";
    }

    string BadgeRol(string? r)
    {
        r ??= "";
        if (r == "?" || r == "" || r == "Unknown") return "bg-secondary";
        return "bg-warning text-dark";
    }

    bool HasAnyFilter =
        !string.IsNullOrWhiteSpace(Model.Buscar) ||
        !string.IsNullOrWhiteSpace(Model.Arquetipo) ||
        !string.IsNullOrWhiteSpace(Model.Posicion) ||
        !string.IsNullOrWhiteSpace(Model.Elemento) ||
        !string.IsNullOrWhiteSpace(Model.Rol);
}

<div class="d-flex align-items-start justify-content-between mb-3">
    <div>
        <h3 class="mb-1">Personajes legendarios</h3>
        <div class="text-muted">Filtra, ordena y busca por nombre o apodo</div>
    </div>
</div>

<!-- FILTROS (Card) -->
<div class="card shadow-sm mb-3">
    <div class="card-body">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-12 col-md-4">
                <label class="form-label mb-1">Buscar</label>
                <input class="form-control" type="text" name="buscar"
                       placeholder="Nombre o apodo…"
                       value="@Model.Buscar" />
            </div>

            <div class="col-6 col-md-2">
                <label class="form-label mb-1">Arquetipo</label>
                <select class="form-select" name="arquetipo">
                    <option value="">Todos</option>
                    @foreach (var item in Model.Arquetipos)
                    {
                        <option value="@item.Value" selected="@(item.Value == Model.Arquetipo)">@item.Text</option>
                    }
                </select>
            </div>

            <div class="col-6 col-md-2">
                <label class="form-label mb-1">Posición</label>
                <select class="form-select" name="posicion">
                    <option value="">Todas</option>
                    @foreach (var item in Model.Posiciones)
                    {
                        <option value="@item.Value" selected="@(item.Value == Model.Posicion)">@item.Text</option>
                    }
                </select>
            </div>

            <div class="col-6 col-md-2">
                <label class="form-label mb-1">Elemento</label>
                <select class="form-select" name="elemento">
                    <option value="">Todos</option>
                    @foreach (var item in Model.Elementos)
                    {
                        <option value="@item.Value" selected="@(item.Value == Model.Elemento)">@item.Text</option>
                    }
                </select>
            </div>

            <div class="col-6 col-md-2">
                <label class="form-label mb-1">Rol</label>
                <select class="form-select" name="rol">
                    <option value="">Todos</option>
                    @foreach (var item in Model.Roles)
                    {
                        <option value="@item.Value" selected="@(item.Value == Model.Rol)">@item.Text</option>
                    }
                </select>
            </div>

            <input type="hidden" name="orden" value="@Model.Orden" />

            <div class="col-12 d-flex gap-2 mt-2">
                <button class="btn btn-primary" type="submit">Aplicar</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Reset</a>

                @* Contador, si tienes TotalFiltrados/TamPagina/Pagina *@
                @if (Model.TotalFiltrados > 0)
                {
                    <div class="ms-auto text-muted small align-self-center">
                        Mostrando @((Model.Pagina - 1) * Model.TamPagina + 1)
                        –
                        @(Math.Min(Model.Pagina * Model.TamPagina, Model.TotalFiltrados))
                        de @Model.TotalFiltrados
                    </div>
                }
            </div>
        </form>

        @* Chips de filtros activos *@
        @if (HasAnyFilter)
        {
            <div class="mt-3 d-flex flex-wrap gap-2">
                @if (!string.IsNullOrWhiteSpace(Model.Buscar))
                {
                    <a class="badge rounded-pill text-bg-secondary text-decoration-none"
                       href="@BuildResetKeep(buscar: null, arquetipo: Model.Arquetipo, posicion: Model.Posicion, elemento: Model.Elemento, rol: Model.Rol)">
                        Buscar: @Model.Buscar ✕
                    </a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Arquetipo))
                {
                    <a class="badge rounded-pill text-bg-secondary text-decoration-none"
                       href="@BuildResetKeep(buscar: Model.Buscar, arquetipo: null, posicion: Model.Posicion, elemento: Model.Elemento, rol: Model.Rol)">
                        Arquetipo: @Model.Arquetipo ✕
                    </a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Posicion))
                {
                    <a class="badge rounded-pill text-bg-secondary text-decoration-none"
                       href="@BuildResetKeep(buscar: Model.Buscar, arquetipo: Model.Arquetipo, posicion: null, elemento: Model.Elemento, rol: Model.Rol)">
                        Posición: @Model.Posicion ✕
                    </a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Elemento))
                {
                    <a class="badge rounded-pill text-bg-secondary text-decoration-none"
                       href="@BuildResetKeep(buscar: Model.Buscar, arquetipo: Model.Arquetipo, posicion: Model.Posicion, elemento: null, rol: Model.Rol)">
                        Elemento: @Model.Elemento ✕
                    </a>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Rol))
                {
                    <a class="badge rounded-pill text-bg-secondary text-decoration-none"
                       href="@BuildResetKeep(buscar: Model.Buscar, arquetipo: Model.Arquetipo, posicion: Model.Posicion, elemento: Model.Elemento, rol: null)">
                        Rol: @Model.Rol ✕
                    </a>
                }
            </div>
        }
    </div>
</div>

<!-- TABLA -->
<div class="table-responsive shadow-sm rounded">
    <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-dark" style="position: sticky; top: 0; z-index: 2;">
            <tr>
                <th style="width:80px;">
                    <a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Id"))">
                        @("Id" + Arrow("Id"))
                    </a>
                </th>

                <th style="width:64px;">Img</th>

                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Nombre"))">@("Nombre" + Arrow("Nombre"))</a></th>
                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Apodo"))">@("Apodo" + Arrow("Apodo"))</a></th>
                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Juego"))">@("Juego" + Arrow("Juego"))</a></th>

                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Arquetipo"))">@("Arquetipo" + Arrow("Arquetipo"))</a></th>
                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Posicion"))">@("Posición" + Arrow("Posicion"))</a></th>
                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Elemento"))">@("Elemento" + Arrow("Elemento"))</a></th>
                <th><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Rol"))">@("Rol" + Arrow("Rol"))</a></th>

                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Potencia"))">@("Pot." + Arrow("Potencia"))</a></th>
                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Control"))">@("Ctrl" + Arrow("Control"))</a></th>
                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Tecnica"))">@("Téc" + Arrow("Tecnica"))</a></th>
                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Presion"))">@("Pres" + Arrow("Presion"))</a></th>
                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Fisico"))">@("Fís" + Arrow("Fisico"))</a></th>
                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Agilidad"))">@("Agi" + Arrow("Agilidad"))</a></th>
                <th class="text-end"><a class="link-light text-decoration-none" href="@BuildUrlOrden(Toggle("Total"))">@("Total" + Arrow("Total"))</a></th>
            </tr>
        </thead>

        <tbody>
            @foreach (var j in Model.Jugadores)
            {
                <tr>
                    <td class="fw-semibold">@j.Id</td>

                    <td>
                        <img src="@j.Imagen"
                             alt="@j.Nombre"
                             class="rounded-circle border"
                             style="width:44px;height:44px;object-fit:cover;"
                             loading="lazy"
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;rounded-circle bg-light border d-flex align-items-center justify-content-center&quot; style=&quot;width:44px;height:44px;&quot;>?</div>';" />
                    </td>

                    <td class="fw-semibold">@j.Nombre</td>
                    <td>@j.Apodo</td>
                    <td>@j.Juego</td>

                    <td><span class="badge @BadgeArquetipo(j.Arquetipo)">@j.Arquetipo</span></td>
                    <td><span class="badge @BadgePosicion(j.Posicion)">@j.Posicion</span></td>
                    <td><span class="badge @BadgeElemento(j.Elemento)">@j.Elemento</span></td>
                    <td><span class="badge @BadgeRol(j.Rol)">@j.Rol</span></td>

                    <td class="text-end">@((j.Potencia?.ToString() ?? "???"))</td>
                    <td class="text-end">@((j.Control?.ToString() ?? "???"))</td>
                    <td class="text-end">@((j.Tecnica?.ToString() ?? "???"))</td>
                    <td class="text-end">@((j.Presion?.ToString() ?? "???"))</td>
                    <td class="text-end">@((j.Fisico?.ToString() ?? "???"))</td>
                    <td class="text-end">@((j.Agilidad?.ToString() ?? "???"))</td>
                    <td class="text-end fw-semibold">@((j.Total?.ToString() ?? "???"))</td>
                </tr>
            }
        </tbody>
    </table>
</div>
@{
    int total = Model.TotalPaginas;
    int current = Model.Pagina;

    int window = 2;
    int start = Math.Max(2, current - window);
    int end = Math.Min(total - 1, current + window);

    string BuildUrlPagina(int p) => Url.Action("Index", "Jugadores", new
    {
        buscar = Model.Buscar,
        arquetipo = Model.Arquetipo,
        posicion = Model.Posicion,
        elemento = Model.Elemento,
        rol = Model.Rol,
        orden = Model.Orden,
        pagina = p
    })!;
}

@if (Model.TotalPaginas > 1)
{
    <nav class="mt-3" aria-label="Paginación">
        <ul class="pagination justify-content-center mb-1">

            <!-- Anterior -->
            <li class="page-item @(current == 1 ? "disabled" : "")">
                <a class="page-link" href="@(current == 1 ? "#" : BuildUrlPagina(current - 1))">‹</a>
            </li>

            <!-- Primera -->
            <li class="page-item @(current == 1 ? "active" : "")">
                <a class="page-link" href="@BuildUrlPagina(1)">1</a>
            </li>

            <!-- ... -->
            @if (start > 2)
            {
                <li class="page-item disabled"><span class="page-link">…</span></li>
            }

            <!-- Intermedias -->
            @for (int p = start; p <= end; p++)
            {
                <li class="page-item @(p == current ? "active" : "")">
                    <a class="page-link" href="@BuildUrlPagina(p)">@p</a>
                </li>
            }

            <!-- ... -->
            @if (end < total - 1)
            {
                <li class="page-item disabled"><span class="page-link">…</span></li>
            }

            <!-- Última -->
            <li class="page-item @(current == total ? "active" : "")">
                <a class="page-link" href="@BuildUrlPagina(total)">@total</a>
            </li>

            <!-- Siguiente -->
            <li class="page-item @(current == total ? "disabled" : "")">
                <a class="page-link" href="@(current == total ? "#" : BuildUrlPagina(current + 1))">›</a>
            </li>

        </ul>

        <div class="text-center text-muted small">
            Mostrando @((current - 1) * Model.TamPagina + 1)
            –
            @(Math.Min(current * Model.TamPagina, Model.TotalFiltrados))
            de @Model.TotalFiltrados
        </div>
    </nav>
}

